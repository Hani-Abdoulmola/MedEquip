<?php

use Illuminate\Support\Facades\Auth;
use Illuminate\Support\Facades\Route;
use App\Http\Controllers\ProfileController;
use App\Http\Controllers\Web\RfqController;
use App\Http\Controllers\Web\UserController;
use App\Http\Controllers\Web\BuyerController;
use App\Http\Controllers\Web\OrderController;
use App\Http\Controllers\Web\ProductController;
use App\Http\Controllers\Web\ProductCategoryController;
use App\Http\Controllers\Web\SettingController;
use App\Http\Controllers\Web\SupplierController;
use App\Http\Controllers\Web\QuotationController;
use App\Http\Controllers\Web\ActivityLogController;
use App\Http\Controllers\Web\NotificationController;
use App\Http\Controllers\Web\ProductReviewController;
use App\Http\Controllers\Web\BuyerDashboardController;
use App\Http\Controllers\Web\Suppliers\SupplierDashboardController;
use App\Http\Controllers\Web\Suppliers\SupplierProductController;

use App\Http\Controllers\Web\RegistrationApprovalController;

Route::get('/', function () {
    return view('home');
})->name('home');

// Main Dashboard Route - Only for Admins
// Suppliers and Buyers have their own dashboard routes
Route::get('/dashboard', function () {
    if (!Auth::check()) {
        return redirect()->route('login');
    }

    $user = Auth::user();

    // Load relationships
    $user->load(['supplierProfile', 'buyerProfile']);

    // Redirect suppliers to their dashboard
    if ($user->supplierProfile) {
        return redirect()->route('supplier.dashboard');
    }

    // Redirect buyers to their dashboard
    if ($user->buyerProfile) {
        return redirect()->route('buyer.dashboard');
    }

    // Admin users see the admin dashboard
    return view('dashboard');
})->middleware('auth')->name('dashboard');

// Waiting Approval Page (for pending/rejected suppliers and buyers)
Route::get('/waiting-approval', function () {
    return view('auth.waiting-approval');
})->middleware('auth')->name('auth.waiting-approval');

Route::middleware('auth')->group(function () {
    Route::get('/profile', [ProfileController::class, 'edit'])->name('profile.edit');
    Route::patch('/profile', [ProfileController::class, 'update'])->name('profile.update');
    Route::delete('/profile', [ProfileController::class, 'destroy'])->name('profile.destroy');

    // Admin Routes - Protected by Admin role
    Route::prefix('admin')->name('admin.')->middleware('role:Admin')->group(function () {
        // Users Management
        Route::get('/users', [UserController::class, 'index'])->name('users');
        Route::get('/users/create', [UserController::class, 'create'])->name('users.create');
        Route::post('/users', [UserController::class, 'store'])->name('users.store');
        Route::put('/users/{user}', [UserController::class, 'update'])->name('users.update');
        Route::get('/users/{user}/edit', [UserController::class, 'edit'])->name('users.edit');
        Route::delete('/users/{user}', [UserController::class, 'destroy'])->name('users.destroy');


        // Suppliers Management
        Route::get('/suppliers', [SupplierController::class, 'index'])
            ->name('suppliers')
            ->middleware('permission:view suppliers');

        Route::get('/suppliers/create', [SupplierController::class, 'create'])
            ->name('suppliers.create')
            ->middleware('permission:create suppliers');

        Route::post('/suppliers', [SupplierController::class, 'store'])
            ->name('suppliers.store')
            ->middleware('permission:create suppliers');

        Route::post('/suppliers/{supplier}/verify', [SupplierController::class, 'verify'])
            ->name('suppliers.verify')
            ->middleware('permission:edit suppliers');

        Route::post('/suppliers/{supplier}/toggle-active', [SupplierController::class, 'toggleActive'])
            ->name('suppliers.toggle-active')
            ->middleware('permission:edit suppliers');

        Route::get('/suppliers/{supplier}', [SupplierController::class, 'show'])
            ->name('suppliers.show')
            ->middleware('permission:view suppliers');

        Route::get('/suppliers/{supplier}/edit', [SupplierController::class, 'edit'])
            ->name('suppliers.edit')
            ->middleware('permission:edit suppliers');

        Route::put('/suppliers/{supplier}', [SupplierController::class, 'update'])
            ->name('suppliers.update')
            ->middleware('permission:edit suppliers');

        Route::delete('/suppliers/{supplier}', [SupplierController::class, 'destroy'])
            ->name('suppliers.destroy')
            ->middleware('permission:delete suppliers');



        // Buyers Management Routes
        Route::get('/buyers', [BuyerController::class, 'index'])
            ->name('buyers')
            ->middleware('permission:view buyers');

        Route::get('/buyers/create', [BuyerController::class, 'create'])
            ->name('buyers.create')
            ->middleware('permission:create buyers');

        Route::post('/buyers', [BuyerController::class, 'store'])
            ->name('buyers.store')
            ->middleware('permission:create buyers');

        Route::get('/buyers/{buyer}', [BuyerController::class, 'show'])
            ->name('buyers.show')
            ->middleware('permission:view buyers');

        Route::get('/buyers/{buyer}/edit', [BuyerController::class, 'edit'])
            ->name('buyers.edit')
            ->middleware('permission:edit buyers');

        Route::put('/buyers/{buyer}', [BuyerController::class, 'update'])
            ->name('buyers.update')
            ->middleware('permission:edit buyers');

        Route::delete('/buyers/{buyer}', [BuyerController::class, 'destroy'])
            ->name('buyers.destroy')
            ->middleware('permission:delete buyers');

        Route::post('/buyers/{buyer}/toggle-active', [BuyerController::class, 'toggleActive'])
            ->name('buyers.toggle-active')
            ->middleware('permission:edit buyers');

        Route::post('/buyers/{buyer}/verify', [BuyerController::class, 'verifyBuyer'])
            ->name('buyers.verify')
            ->middleware('permission:edit buyers');



        // Products Management
        Route::get('/products', [ProductController::class, 'index'])
            ->name('products.index')
            ->middleware('permission:view products');
        Route::get('/products/{product}', [ProductController::class, 'show'])
            ->name('products.show')
            ->middleware('permission:view products');
        Route::get('/products/{product}/review',
            [ProductReviewController::class, 'review']
        )->name('products.review');
        Route::post('/products/{product}/approve',
            [ProductReviewController::class, 'approve']
        )->name('products.approve');
        Route::post('/products/{product}/reject',
            [ProductReviewController::class, 'reject']
        )->name('products.reject');
        Route::post('/products/{product}/request-changes',
            [ProductReviewController::class, 'requestChanges']
        )->name('products.request_changes');
        Route::delete('/products/{product}', [ProductController::class, 'destroy'])
            ->name('products.destroy')
            ->middleware('permission:delete products');


        // Product Categories Management
        Route::get('/categories', [ProductCategoryController::class, 'index'])->name('categories.index');
        Route::get('/categories/create', [ProductCategoryController::class, 'create'])->name('categories.create');
        Route::post('/categories', [ProductCategoryController::class, 'store'])->name('categories.store');
        Route::get('/categories/{category}', [ProductCategoryController::class, 'show'])->name('categories.show');
        Route::get('/categories/{category}/edit', [ProductCategoryController::class, 'edit'])->name('categories.edit');
        Route::put('/categories/{category}', [ProductCategoryController::class, 'update'])->name('categories.update');
        Route::delete('/categories/{category}', [ProductCategoryController::class, 'destroy'])->name('categories.destroy');


        // Orders Management
        Route::get('/orders', [OrderController::class, 'index'])
            ->name('orders')
            ->middleware('permission:view orders');
        Route::get('/orders/create', [OrderController::class, 'create'])
            ->name('orders.create')
            ->middleware('permission:create orders');
        Route::post('/orders', [OrderController::class, 'store'])
            ->name('orders.store')
            ->middleware('permission:create orders');
        Route::get('/orders/{order}', [OrderController::class, 'show'])
            ->name('orders.show')
            ->middleware('permission:view orders');
        Route::get('/orders/{order}/edit', [OrderController::class, 'edit'])
            ->name('orders.edit')
            ->middleware('permission:edit orders');
        Route::put('/orders/{order}', [OrderController::class, 'update'])
            ->name('orders.update')
            ->middleware('permission:edit orders');
        Route::delete('/orders/{order}', [OrderController::class, 'destroy'])
            ->name('orders.destroy')
            ->middleware('permission:delete orders');

        // Reports
        Route::get('/reports', fn() => view('admin.reports.index'))->name('reports');

        // Activity Log
        Route::get('/activity', [ActivityLogController::class, 'index'])
            ->name('activity')
            ->middleware('permission:view activity logs');
        Route::get('/activity/{activity}', [ActivityLogController::class, 'show'])
            ->name('activity.show')
            ->middleware('permission:view activity logs');

        // Registration Approvals
        Route::get('/registrations/pending', [RegistrationApprovalController::class, 'index'])
            ->name('registrations.pending')
            ->middleware('permission:view users');
        Route::post('/registrations/{type}/{id}/approve', [RegistrationApprovalController::class, 'approve'])
            ->name('registrations.approve')
            ->middleware('permission:edit users');
        Route::post('/registrations/{type}/{id}/reject', [RegistrationApprovalController::class, 'reject'])
            ->name('registrations.reject')
            ->middleware('permission:edit users');

        // Settings
        Route::get('/settings', [SettingController::class, 'index'])
            ->name('settings.index')
            ->middleware('permission:view users');

        Route::post('/settings/general', [SettingController::class, 'updateGeneral'])
            ->name('settings.update.general')
            ->middleware('permission:edit users');

        Route::post('/settings/email', [SettingController::class, 'updateEmail'])
            ->name('settings.update.email')
            ->middleware('permission:edit users');

        Route::post('/settings/payment', [SettingController::class, 'updatePayment'])
            ->name('settings.update.payment')
            ->middleware('permission:edit users');

        Route::post('/settings/security', [SettingController::class, 'updateSecurity'])
            ->name('settings.update.security')
            ->middleware('permission:edit users');

        Route::post('/settings/email/test', [SettingController::class, 'testEmailConnection'])
            ->name('settings.email.test')
            ->middleware('permission:edit users');

        // Notifications
        Route::get('/notifications', [NotificationController::class, 'index'])
            ->name('notifications.index');

        Route::post('/notifications/{id}/read', [NotificationController::class, 'markAsRead'])
            ->name('notifications.read');

        Route::post('/notifications/read-all', [NotificationController::class, 'markAllAsRead'])
            ->name('notifications.read-all');

        Route::delete('/notifications/{id}', [NotificationController::class, 'destroy'])
            ->name('notifications.destroy');

        Route::delete('/notifications', [NotificationController::class, 'destroyAll'])
            ->name('notifications.destroy-all');
    });

    // Supplier Routes
    Route::prefix('supplier')->name('supplier.')->middleware('role:Supplier')->group(function () {
        // Supplier Dashboard
        Route::get('/dashboard', [SupplierDashboardController::class, 'index'])->name('dashboard');

        // Supplier Products (Full CRUD)
        Route::resource('products', SupplierProductController::class)->except(['destroy']);
        Route::delete('/products/{product}', [SupplierProductController::class, 'destroy'])->name('products.destroy');

        // Supplier Resources
        Route::get('/orders', [OrderController::class, 'index'])->name('orders');
        Route::get('/quotations', [QuotationController::class, 'index'])->name('quotations');
        Route::get('/rfqs', [RfqController::class, 'index'])->name('rfqs');
        // Route::get('/sales', fn() => view('supplier.sales'))->name('sales');
        Route::get('/profile', [ProfileController::class, 'edit'])->name('profile');
    });

    // Buyer Routes
    Route::prefix('buyer')->name('buyer.')->middleware('role:Buyer')->group(function () {
        // Buyer Dashboard
        Route::get('/dashboard', [BuyerDashboardController::class, 'index'])->name('dashboard');

        // Buyer Resources
        Route::get('/orders', [OrderController::class, 'index'])->name('orders');
        Route::get('/favorites', fn() => view('buyer.favorites'))->name('favorites');
        Route::get('/suppliers', fn() => view('buyer.suppliers'))->name('suppliers');
    });
});

require __DIR__.'/auth.php';
